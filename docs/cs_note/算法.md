- ### 10G个整数找出中位数，内存限制为2G

  32位无符号整数，范围为0-2^32 - 1，4G种取值，映射到256M个区间，每个区间16种值，每16个值算一段，共256M段，每一段用8B空间来计数表示，共需要256M*8B=2G空间。

  10G个整数全部映射完后，从前向后计数，当累计超过5G时停止，找到这个区段的数值范围，同时记录累计到上一个区间的总数m，然后释放这个区段的内存。

  在读一边10G个整数，把在找出的区间中的值计数，共有16个计数，对新的计数累加，当累加的和n+m超过5G停止，找到中位数

  总的来说就是将10G个整数在内存中表示10G这个整数需要64位（8字节）来存储，这样2G的空间一共可以存储256M个8字节。假设是32位无符号整数，则最多共有4G中取值，每个区间对应16个数字的计数。将10G整数映射到256M区间后累加超过5G停止，表示中位数在该区间上，而该区间共有16个值。为了确定是哪个值，需要释放之前的空间存储，将10G整数在该区间上的数再映射分为16个计数后，再累加计算中位数是哪一个。

  

  解法：首先假设是32位无符号整数。
\1. 读一遍10G个整数，把整数映射到256M个区段中，用一个64位无符号整数给每个相应区段记数。
  说 明：整数范围是0 - 2^32 - 1，一共有4G种取值，映射到256M个区段，则每个区段有16（4G/256M = 16）种值，每16个值算一段， 0～15是第1段，16～31是第2段，……2^32-16 ～2^32-1是第256M段。一个64位无符号整数最大值是0～8G-1，这里先不考虑溢出的情况。总共占用内存256M×8B=2GB。

  \2. 从前到后对每一段的计数累加，当累加的和超过5G时停止，找出这个区段（即累加停止时达到的区段，也是中位数所在的区段）的数值范围，设为[a，a+15]，同时记录累加到前一个区段的总数，设为m。然后，释放除这个区段占用的内存。

  \3. 再读一遍10G个整数，把在[a，a+15]内的每个值计数，即有16个计数。

  \4. 对新的计数依次累加，每次的和设为n，当m+n的值超过5G时停止，此时的这个计数所对应的数就是中位数。

  总结：
1.以上方法只要读两遍整数，对每个整数也只是常数时间的操作，总体来说是线性时间
  

  
### 海量数据中找topk的问题
  
总结：hash为多个小文件-->unordered_map记录关键字出现的次数——》利用堆排序获取最大的k个数据
  
首先根据现有机器内存的最大空间，通过hash值将海量数据映射到若干个小文件中，保证内存可以存放的下小文件，如果数据都集中再同一种文件空间不能存下，则再通过hash映射分为更小的文件，可以保证相同的数据记录再同一个文件中。
  
之后把每个小文件载入内存，通过ordered_map记录每个小文件关键字出现的次数。
  
最后通过建立小根堆，获取出现次数最多的k个数据
  

  
# 大数据排序
  
给100亿个数字排序，100亿个 int 型数字放在文件里面大概有 37.2GB，非常大，内存一次装不下了。那么肯定是要拆分成小的文件一个一个来处理，最终在合并成一个排好序的大文件。
  
**实现思路**
  
  1.把这个37GB的大文件，用哈希分成1000个小文件，每个小文件平均38MB左右（理想情况），把100亿个数字对1000取模，模出来的结果在0到999之间，每个结果对应一个文件，所以我这里取的哈希函数是 h = x % 1000，哈希函数取得"好"，能使冲突减小，结果分布均匀。

  2.拆分完了之后，得到一些几十MB的小文件，那么就可以放进内存里排序了，可以用快速排序，归并排序，堆排序等等。

  3.1000个小文件内部排好序之后，就要把这些内部有序的小文件，合并成一个大的文件，可以用**二叉堆**来做1000路合并的操作，每个小文件是一路，合并后的大文件仍然有序。

  - 首先遍历1000个文件，每个文件里面取第一个数字，组成 (数字, 文件号) 这样的组合加入到堆里（假设是从小到大排序，用小顶堆），遍历完后堆里有1000个 (数字，文件号) 这样的元素
- 然后不断从堆顶拿元素出来，每拿出一个元素，把它的文件号读取出来，然后去对应的文件里，加一个元素进入堆，直到那个文件被读取完。拿出来的元素当然追加到最终结果的文件里。
  
- 按照上面的操作，直到堆被取空了，此时最终结果文件里的全部数字就是有序的了。
  
### 思维拓展
  
类似的100亿个数字求和，求中位数，求平均数，套路就是一样的了。
  
求和：统计每个小文件的和，返回给master再求和就可以了。
  
求平均数：上面能求和了，再除以100亿就是平均数了
  
求中位数：在排序的基础上，遍历到中间的那个数就是中位数了。